{"version":3,"sources":["../../src/lightstep-datasource/datasource.js"],"names":["_","moment","appEvents","kbn","maxDataPointsServer","minResolutionServer","version","secondMs","on","link","get","options","window","open","LightStepDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","dashboardURL","jsonData","name","q","organizationName","projectName","apiKey","targets","filter","t","hide","maxDataPoints","length","when","data","targetResponses","flatMap","interpolatedIds","replace","target","interpolatedNames","replaceWithText","undefined","streamIds","split","streamNames","zip","map","streamId","pair","streamName","queryParams","buildQueryParameters","showErrorCounts","Boolean","showErrorCountsAsRate","showErrorsPerSec","showOpsCounts","showOpsPerSec","response","doRequest","method","params","then","result","displayName","res","all","results","attributes","resolution","series","concat","parseLatencies","parseExemplars","ops","parseCount","errs","parseRateFromCounts","status","message","title","catch","error","grafanaQuery","interpolated","queryMapper","defaultMapper","parseQuery","streams","stream","stream_query","id","trim","text","value","startsWith","parseStreamIdsQuery","parseAttributesQuery","Error","matches","match","attribute_name","operator","filter_value","applyOperator","attribute","not","charAt","substring","regex","RegExp","test","headers","datasourceRequest","oldest","range","from","youngest","to","resolutionMs","scopedVars","getScopedVars","interval_to_ms","Math","max","diff","min","format","floor","showExemplars","extractPercentiles","percentiles","msRange","regularRange","secondsToHms","__interval","interval","__range","timeWindows","timeWindow","latencies","datapoints","exemplars","exemplarMap","groupBy","exemplar","parseExemplar","skip","ceil","ignored","index","traceLink","spanGuid","key","points","val","errors","timeMap","forEach","p","timestamp","curr","errCount","opsCount","Object","keys","k","v","toString","percentile"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\nimport appEvents from 'app/core/app_events';\nimport kbn from 'app/core/utils/kbn';\n\nconst maxDataPointsServer = 1440;\nconst minResolutionServer = 60000;\nconst version = 'v0.2';\nconst secondMs = 1000;\n\n// TODO - this is a work around given the existing graph API\n// Having a better mechanism for click capture would be ideal.\nappEvents.on('graph-click', options => {\n  const link = _.get(options, [\n    'ctrl',\n    'dataList',\n    _.get(options, ['item', 'seriesIndex']),\n    'datapoints',\n    _.get(options, ['item', 'dataIndex']),\n    2,\n  ]);\n  if (link) {\n    window.open(link, '_blank');\n  }\n});\n\nexport class LightStepDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.dashboardURL = instanceSettings.jsonData.dashboardURL;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.organizationName = instanceSettings.jsonData.organizationName;\n    this.projectName = instanceSettings.jsonData.projectName;\n    this.apiKey = instanceSettings.jsonData.apiKey;\n  }\n\n  headers() {\n    return {\n      'Content-Type': 'application/json',\n      'Authorization': \"BEARER \" + this.apiKey,\n    };\n  }\n\n  query(options) {\n    const targets = options.targets.filter(t => !t.hide);\n    const maxDataPoints = options.maxDataPoints;\n\n    if (targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    const targetResponses = targets.flatMap(target => {\n      const interpolatedIds = this.templateSrv.replace(target.target, null, 'pipe');\n      const interpolatedNames = this.templateSrv.replaceWithText(target.target);\n\n      if (!interpolatedIds) {\n        return this.q.when(undefined);\n      }\n\n      const streamIds = interpolatedIds.split('|');\n      const streamNames = interpolatedNames.split(' + ');\n      return _.zip(streamIds, streamNames).map(pair => {\n        const streamId = pair[0];\n        const streamName = pair[1];\n        const queryParams = this.buildQueryParameters(options, target, maxDataPoints);\n        const showErrorCounts = Boolean(target.showErrorCounts);\n        const showErrorCountsAsRate = Boolean(target.showErrorCountsAsRate);\n        const showErrorsPerSec = Boolean(target.showErrorsPerSec);\n        const showOpsCounts = Boolean(target.showOpsCounts);\n        const showOpsPerSec = Boolean(target.showOpsPerSec);\n\n        const response = this.doRequest({\n          url: `${this.url}/public/${version}/${this.organizationName}/projects/${this.projectName}/streams/${streamId}/timeseries`,\n          method: 'GET',\n          params: queryParams,\n        });\n\n        response.then(result => {\n          if (result && result[\"data\"][\"data\"]) {\n            if (target.displayName) {\n              result[\"data\"][\"data\"][\"name\"] = this.templateSrv.replaceWithText(target.displayName);\n            } else {\n              result[\"data\"][\"data\"][\"name\"] = streamName;\n            }\n          }\n        });\n\n        return response.then((res) => {\n          res.showErrorCountsAsRate = showErrorCountsAsRate;\n          res.showOpsCounts = showOpsCounts;\n          res.showOpsPerSec = showOpsPerSec;\n          res.showErrorCounts = showErrorCounts;\n          res.showErrorsPerSec = showErrorsPerSec;\n          return res;\n        });\n      });\n\n    });\n\n    return this.q.all(targetResponses).then(results => {\n      const data = _.flatMap(results, result => {\n        if (!result) {\n          return [];\n        }\n\n        const data = result[\"data\"][\"data\"];\n        const attributes = data[\"attributes\"];\n        const resolution = attributes[\"resolution-ms\"] / secondMs;\n        const name = data[\"name\"];\n\n        let series = [].concat(\n          this.parseLatencies(name, attributes),\n          this.parseExemplars(name, attributes, maxDataPoints),\n        );\n\n        const ops = this.parseCount(`${name} Ops counts`, \"ops-counts\", attributes);\n\n        if (result.showOpsCounts) {\n          series = series.concat(ops);\n        }\n\n        if (result.showOpsPerSec && resolution) {\n          series = series.concat(this.parseCount(`${name} Ops per sec`, \"ops-counts\", attributes, resolution));\n        }\n\n        if (result.showErrorCountsAsRate) {\n          let errs = this.parseCount(`${name} Error counts`, \"error-counts\", attributes);\n\n          if (result.showErrorCountsAsRate) {\n            errs = this.parseRateFromCounts(`${name} Error rate`, errs, ops);\n          }\n\n          series = series.concat(errs);\n        }\n\n        if (result.showErrorsPerSec && resolution) {\n          series = series.concat(this.parseCount(`${name} Errors per sec`, \"error-counts\", attributes, resolution));\n        }\n\n        return series;\n      });\n\n      return { data: data };\n    });\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: `${this.url}/public/${version}/${this.organizationName}/projects/${this.projectName}`,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n      }\n    }).catch(error => {\n      return { status: \"error\", message: error, title: \"Error \" };\n    });\n  }\n\n  annotationQuery(options) {\n    return this.q.when({});\n  }\n\n  metricFindQuery(grafanaQuery) {\n    const interpolated = this.templateSrv.replace(grafanaQuery, null, 'regex');\n\n    let queryMapper = this.defaultMapper();\n    if (interpolated) {\n      queryMapper = this.parseQuery(interpolated);\n    }\n\n    return this.doRequest({\n      url: `${this.url}/public/${version}/${this.organizationName}/projects/${this.projectName}/streams`,\n      method: 'GET',\n    }).then(response => {\n      const streams = response.data.data;\n      return _.flatMap(streams, stream => {\n        const attributes = stream[\"attributes\"];\n        const name = attributes[\"name\"];\n        const stream_query = attributes[\"query\"];\n        const streamId = stream[\"id\"];\n\n        return queryMapper(name, stream_query, streamId);\n      });\n    });\n  }\n\n  defaultMapper() {\n    return (name, stream_query, id) => {\n      // Don't duplicate if the name and stream_query are the same\n      if (name.trim() === stream_query.trim()) {\n        return [ { text: name, value: id } ];\n      }\n\n      return [\n        { text: stream_query, value: id },\n        { text: name, value: id },\n      ];\n    }\n  }\n\n  parseQuery(grafanaQuery) {\n    if (grafanaQuery.startsWith('stream_ids(')) {\n      return this.parseStreamIdsQuery(grafanaQuery);\n    } else if (grafanaQuery.startsWith('attributes(')) {\n      return this.parseAttributesQuery(grafanaQuery);\n    } else {\n      throw new Error(`Unknown query provided: ${grafanaQuery}`);\n    }\n  }\n\n  parseStreamIdsQuery(grafanaQuery) {\n    const matches = grafanaQuery.match(/stream_ids\\(([^\\!=~]+)(\\!?=~?)\"(.*)\"\\)$/)\n    if (matches && matches.length == 4) {\n      const attribute_name = matches[1],\n            operator = matches [2],\n            filter_value = matches[3];\n      return (name, stream_query, id) => {\n        switch (attribute_name) {\n          case \"name\":\n            return this.applyOperator(name, operator, filter_value, id)\n          case \"stream_query\":\n            return this.applyOperator(stream_query, operator, filter_value, id)\n          default:\n            throw new Error(`Unknown attribute provided in the stream_ids() query: ${attribute_name}`);\n        }\n      }\n    }\n    throw new Error(`Unknown query provided: ${grafanaQuery}`);\n  }\n\n  applyOperator(attribute, operator, filter_value, id) {\n    let match;\n    let not = false;\n    if (operator.charAt(0) == \"!\") {\n      operator = operator.substring(1);\n      not = true;\n    }\n    switch (operator) {\n      case \"=\":\n        match = attribute == filter_value\n        break;\n      case \"=~\":\n        const regex = new RegExp(filter_value)\n        match = regex.test(attribute)\n        break;\n      default:\n        throw new Error(`Unknown operator provided: ${operator}`);\n    }\n    match ^= not;\n    return match ? [{ text: `${attribute}`, value: id }] : []\n  }\n\n  parseAttributesQuery(grafanaQuery) {\n    const matches = grafanaQuery.match(/^attributes\\(([^)]+)\\)$/);\n    if (matches && matches.length == 2) {\n      return (name, stream_query, id) => {\n        switch (matches[1]) {\n          case \"name\":\n            return [{ text: name }]\n          case \"stream_query\":\n            return [{ text: stream_query }]\n          default:\n            throw new Error(`Unknown attribute provided in the attributes() query: ${matches[1]}`);\n        }\n      };\n    }\n    throw new Error(`Unknown query provided: ${grafanaQuery}`);\n  }\n\n  doRequest(options) {\n    options.headers = this.headers();\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options, target, maxDataPoints) {\n    const oldest = options.range.from;\n    const youngest = options.range.to;\n\n    let resolutionMs = null;\n    if (target.resolution) {\n      const scopedVars = this.getScopedVars(options);\n      const interpolated = this.templateSrv.replace(target.resolution, scopedVars)\n      resolutionMs = kbn.interval_to_ms(interpolated);\n    }\n\n    if (!resolutionMs || resolutionMs < minResolutionServer) {\n      resolutionMs = Math.max(\n        youngest.diff(oldest) / Math.min(\n          maxDataPoints,\n          maxDataPointsServer\n        ),\n        minResolutionServer\n      );\n    }\n\n    return {\n      \"oldest-time\": oldest.format(),\n      \"youngest-time\": youngest.format(),\n      \"resolution-ms\": Math.floor(resolutionMs),\n      \"include-exemplars\": target.showExemplars ? \"1\" : \"0\",\n      \"include-ops-counts\": (target.showOpsPerSec || target.showOpsCounts) ? \"1\" : \"0\",\n      \"include-error-counts\": (target.showErrorsPerSec || target.showErrorCounts) ? \"1\" : \"0\",\n      \"percentile\": this.extractPercentiles(target.percentiles),\n    };\n  }\n\n  getScopedVars(options) {\n    const msRange = options.range.to.diff(options.range.from);\n    const regularRange = kbn.secondsToHms(msRange / 1000);\n    return {\n      __interval: { text: options.interval, value: options.interval },\n      __range: { text: regularRange, value: regularRange },\n    };\n  }\n\n  parseLatencies(name, attributes) {\n    if (!attributes[\"time-windows\"] || !attributes[\"latencies\"]) {\n      return [];\n    }\n\n    const timeWindows = attributes[\"time-windows\"].map(timeWindow => {\n      const oldest = moment(timeWindow[\"oldest-time\"]);\n      const youngest = moment(timeWindow[\"youngest-time\"]);\n      return moment((oldest + youngest) / 2);\n    });\n\n    return attributes[\"latencies\"].map(latencies => {\n      return {\n        target: `${name} p${latencies[\"percentile\"]}`,\n        datapoints: _.zip(latencies[\"latency-ms\"], timeWindows),\n      };\n    })\n  }\n\n  parseExemplars(name, attributes, maxDataPoints) {\n    const exemplars = attributes[\"exemplars\"];\n    if (!exemplars) {\n      return [];\n    }\n    const exemplarMap = _.groupBy(exemplars, exemplar => exemplar[\"has_error\"]);\n\n    return _.concat(\n      this.parseExemplar(`${name} traces`, exemplarMap[false], maxDataPoints),\n      this.parseExemplar(`${name} error traces`, exemplarMap[true], maxDataPoints),\n    )\n  }\n\n  parseExemplar(name, exemplars, maxDataPoints) {\n    if (!exemplars) {\n      return []\n    }\n    if (maxDataPoints && exemplars.length > maxDataPoints) {\n      const skip = Math.ceil(exemplars.length / maxDataPoints);\n      exemplars = exemplars.filter((ignored, index) => index % skip === 0);\n    }\n    return [{\n      target: name,\n      datapoints: exemplars.map(exemplar => {\n        return {\n          0: exemplar[\"duration_micros\"] / 1000,\n          1: moment(((exemplar[\"oldest_micros\"] + exemplar[\"youngest_micros\"]) / 2) / 1000),\n          2: this.traceLink(exemplar),\n        };\n      }),\n    }];\n  }\n\n  traceLink(exemplar) {\n    const spanGuid = exemplar[\"span_guid\"];\n    if (!spanGuid) {\n      return\n    }\n    return `${this.dashboardURL}/${this.projectName}/trace?span_guid=${spanGuid}`\n  }\n\n  parseCount(name, key, attributes, resolution) {\n    if (!attributes[\"time-windows\"] || !attributes[key]) {\n      return [];\n    }\n\n    const timeWindows = attributes[\"time-windows\"].map(timeWindow => {\n      const oldest = moment(timeWindow[\"oldest-time\"]);\n      const youngest = moment(timeWindow[\"youngest-time\"]);\n      return moment((oldest + youngest) / 2);\n    });\n\n    let points = attributes[key];\n\n    if(resolution) {\n      points = points.map((val) => {\n        return val / resolution;\n      });\n    }\n\n    const datapoints = _.zip(points, timeWindows);\n    return [{\n      target: name,\n      datapoints: datapoints,\n    }]\n  }\n\n\n\n  parseRateFromCounts(name, errors, ops) {\n    if (!errors[0] || !ops[0] || !errors[0].datapoints || !ops[0].datapoints || (errors[0].datapoints.length != ops[0].datapoints.length)) {\n      return [];\n    }\n\n    let timeMap = {};\n    // make a map of moment ISO timestamps\n    errors[0].datapoints.forEach((p) => {\n      // store error count in 0\n      // store original moment object in 1\n      timeMap[p[1].format()] = [p[0], p[1]];\n    });\n\n    ops[0].datapoints.forEach((p) => {\n      let timestamp = p[1].format();\n      // retrieve corresponding error count value from timeMap\n      let curr = timeMap[timestamp]; // curr[0] = error count, curr[1] is original moment object\n      // only do math if the points exist & are non-zero\n      let errCount = curr[0];\n      if (!errCount) {\n        return;\n      }\n      let opsCount = p[0];\n      if (errCount == 0 || opsCount == 0) {\n        timeMap[timestamp] = [0, curr[1]];\n      } else {\n        let res = (errCount / opsCount)*100;\n        timeMap[timestamp] = [res, curr[1]];\n      }\n    });\n\n    let datapoints = Object.keys(timeMap).map((k) => {\n      // restore moment object\n      let v = timeMap[k];\n      return [v[0], v[1]];\n    });\n\n    return [{\n      target: name,\n      datapoints,\n    }];\n  }\n\n  extractPercentiles(percentiles) {\n    if (!percentiles) {\n      return [];\n    }\n    return (percentiles)\n      .toString()\n      .split(\",\")\n      .map(percentile => percentile.replace(/(^\\s+|\\s+$)/g,''))\n      .filter(percentile => percentile);\n  }\n}\n"]}